--source include/have_udf.inc

#
# Creating functions from encryption_udf
#

--replace_result $ENCRYPTION_UDF_LIB ENCRYPTION_UDF_LIB
eval CREATE FUNCTION create_asymmetric_priv_key RETURNS STRING SONAME "$ENCRYPTION_UDF_LIB";

--replace_result $ENCRYPTION_UDF_LIB ENCRYPTION_UDF_LIB
eval CREATE FUNCTION create_asymmetric_pub_key RETURNS STRING SONAME "$ENCRYPTION_UDF_LIB";

--echo
--echo ** checking 'create_dh_parameters()' function basics
--replace_result $ENCRYPTION_UDF_LIB ENCRYPTION_UDF_LIB
eval CREATE FUNCTION create_dh_parameters RETURNS STRING SONAME "$ENCRYPTION_UDF_LIB";

--error ER_CANT_INITIALIZE_UDF
SELECT create_dh_parameters();

--error ER_UDF_ERROR
SELECT create_dh_parameters(NULL);
--error ER_UDF_ERROR
SELECT create_dh_parameters(0);
--error ER_UDF_ERROR
SELECT create_dh_parameters(-1);
--error ER_UDF_ERROR
SELECT create_dh_parameters('blah');

--error ER_UDF_ERROR
SELECT create_dh_parameters(1023);

--error ER_UDF_ERROR
SELECT create_dh_parameters(10001);


SET @dh_params = create_dh_parameters(1024);

SET @dh_priv1 = create_asymmetric_priv_key('DH', @dh_params);
SET @dh_pub1 =  create_asymmetric_pub_key('DH', @dh_priv1);

SET @dh_priv2 = create_asymmetric_priv_key('DH', @dh_params);
SET @dh_pub2 =  create_asymmetric_pub_key('DH', @dh_priv2);


--echo
--echo ** checking 'asymmetric_derive()' function basics
--replace_result $ENCRYPTION_UDF_LIB ENCRYPTION_UDF_LIB
eval CREATE FUNCTION asymmetric_derive RETURNS STRING SONAME "$ENCRYPTION_UDF_LIB";

--error ER_CANT_INITIALIZE_UDF
SELECT asymmetric_derive();

--error ER_UDF_ERROR
SELECT asymmetric_derive(NULL, @dh_priv2);
--error ER_UDF_ERROR
SELECT asymmetric_derive(42, @dh_priv2);
--error ER_UDF_ERROR
SELECT asymmetric_derive('blah-blah', @dh_priv2);

--error ER_UDF_ERROR
SELECT asymmetric_derive(@dh_pub1, NULL);
--error ER_UDF_ERROR
SELECT asymmetric_derive(@dh_pub1, 42);
--error ER_UDF_ERROR
SELECT asymmetric_derive(@dh_pub1, 'blah-blah');

--error ER_UDF_ERROR
SELECT asymmetric_derive(@dh_pub1, @dh_pub2);
--error ER_UDF_ERROR
SELECT asymmetric_derive(@dh_priv1, @dh_priv2);

#
# Dropping functions from encryption_udf
#
DROP FUNCTION asymmetric_derive;
DROP FUNCTION create_dh_parameters;
DROP FUNCTION create_asymmetric_pub_key;
DROP FUNCTION create_asymmetric_priv_key;
