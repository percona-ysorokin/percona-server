--source include/have_debug.inc
--source include/have_debug_sync.inc
--source include/have_masking_functions_component.inc
--source include/rpl/init_source_replica.inc

--source include/rpl/connection_source.inc
SET GLOBAL DEBUG='+d,masking_functions_signal_on_cache_reload';
INSTALL COMPONENT 'file://component_masking_functions';
--source include/rpl/connection_replica.inc
SET GLOBAL DEBUG='+d,masking_functions_signal_on_cache_reload';
INSTALL COMPONENT 'file://component_masking_functions';

--source include/rpl/connection_source.inc
CREATE TABLE mysql.masking_dictionaries(
    Dictionary VARCHAR(256) NOT NULL,
    Term VARCHAR(256) NOT NULL,
    UNIQUE INDEX dictionary_term_idx (Dictionary, Term)
) ENGINE = InnoDB DEFAULT CHARSET=utf8mb4;

GRANT MASKING_DICTIONARIES_ADMIN ON *.* TO root@localhost;

SELECT masking_dictionary_term_add('single_dict_1', 'entry_1');
SELECT masking_dictionary_term_add('single_dict_2', 'entry_2');
SELECT gen_dictionary('single_dict_1');
SELECT gen_dictionary('single_dict_2');

--source include/rpl/sync.inc
--source include/rpl/connection_replica.inc

GRANT MASKING_DICTIONARIES_ADMIN ON *.* TO root@localhost;
SELECT * FROM mysql.masking_dictionaries;
SELECT masking_dictionaries_flush();
SELECT gen_dictionary('single_dict_1');
SELECT gen_dictionary('single_dict_2');

--source include/rpl/connection_source.inc

INSERT INTO mysql.masking_dictionaries VALUES ('single_dict_3', 'entry_3');

# Source must return NULL as dictionary flusher thread is suspended
SELECT gen_dictionary('single_dict_3');

SET DEBUG_SYNC='now SIGNAL masking_functions_before_cache_reload WAIT_FOR masking_functions_after_cache_reload';

# Source must return a non-NULL value as flusher thread is expected to reload dictionary content at this point
SELECT gen_dictionary('single_dict_3');

--source include/rpl/sync.inc
--source include/rpl/connection_replica.inc

SELECT * FROM mysql.masking_dictionaries;

# Replica must return NULL as dictionary flusher thread is suspended
SELECT gen_dictionary('single_dict_3');

SET DEBUG_SYNC='now SIGNAL masking_functions_before_cache_reload WAIT_FOR masking_functions_after_cache_reload';

# Replica must return a non-NULL value as flusher thread is expected to reload dictionary content at this point
SELECT gen_dictionary('single_dict_3');

#
# Cleanup
--source include/rpl/connection_replica.inc
REVOKE MASKING_DICTIONARIES_ADMIN ON *.* FROM root@localhost;
SET GLOBAL DEBUG='-d,masking_functions_signal_on_cache_reload';
UNINSTALL COMPONENT 'file://component_masking_functions';

--source include/rpl/connection_source.inc
REVOKE MASKING_DICTIONARIES_ADMIN ON *.* FROM root@localhost;
SET GLOBAL DEBUG='-d,masking_functions_signal_on_cache_reload';
UNINSTALL COMPONENT 'file://component_masking_functions';

DROP TABLE mysql.masking_dictionaries;

--source include/rpl/sync.inc
--source include/rpl/deinit.inc
